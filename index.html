<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tipping</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function TippingApp() {
            const [selectedDay, setSelectedDay] = useState('midtuke');
            const [matches, setMatches] = useState([]);
            const [selections, setSelections] = useState({});
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const days = {
                midtuke: "3",
                lordag: "1",
                sondag: "2"
            };

            const fetchMatches = async (day) => {
                setLoading(true);
                setError(null);
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const tippingUrl = encodeURIComponent(`https://www.norsk-tipping.no/sport/tipping/spill?day=${days[day]}`);
                    
                    const response = await fetch(proxyUrl + tippingUrl);
                    if (!response.ok) throw new Error('Nettverksfeil');
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Finn alle span elementer som matcher mønsteret for kampinfo
                    const matchElements = doc.querySelectorAll('.flex.justify-start.text-xs.md\\:text-sm.text-ellipsis');
                    
                    const newMatches = Array(12).fill(null).map((_, index) => {
                        const matchElement = Array.from(matchElements).find(el => el.textContent.startsWith(`${index + 1} `));
                        if (matchElement) {
                            const matchText = matchElement.textContent;
                            const [_, ...teams] = matchText.split(' '); // Fjern kampnummer
                            const [homeTeam, awayTeam] = teams.join(' ').split(' - ');
                            return {
                                id: index + 1,
                                homeTeam: homeTeam || '',
                                awayTeam: awayTeam || ''
                            };
                        }
                        return {
                            id: index + 1,
                            homeTeam: '',
                            awayTeam: ''
                        };
                    });
                    
                    setMatches(newMatches);
                } catch (err) {
                    setError('Kunne ikke hente kampene: ' + err.message);
                    console.error('Feil ved henting av kamper:', err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchMatches(selectedDay);
            }, [selectedDay]);

            const handleSelection = (matchId, type) => {
                setSelections(prev => {
                    const current = prev[matchId] || {};
                    const updated = {
                        ...prev,
                        [matchId]: {
                            H: type === 'H' ? !current.H : false,
                            U: type === 'U' ? !current.U : false,
                            B: type === 'B' ? !current.B : false,
                        }
                    };
                    return updated;
                });
            };

            return (
                <div className="container mx-auto p-4">
                    <div className="bg-white shadow-lg rounded-lg p-6">
                        <div className="mb-6">
                            <h1 className="text-2xl font-bold mb-4">Tippekupongen</h1>
                            <select 
                                value={selectedDay}
                                onChange={(e) => setSelectedDay(e.target.value)}
                                className="w-full max-w-xs p-2 border rounded shadow-sm"
                            >
                                <option value="midtuke">Midtuke</option>
                                <option value="lordag">Lørdag</option>
                                <option value="sondag">Søndag</option>
                            </select>
                        </div>

                        {loading && (
                            <div className="text-center p-4">
                                Henter kampene...
                            </div>
                        )}

                        {error && (
                            <div className="text-red-600 p-4 border border-red-300 rounded mb-4">
                                {error}
                                <button 
                                    onClick={() => fetchMatches(selectedDay)}
                                    className="ml-4 px-3 py-1 bg-red-100 rounded hover:bg-red-200"
                                >
                                    Prøv igjen
                                </button>
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="p-2 border text-left">Kamp</th>
                                        <th className="p-2 border text-left">Hjemmelag</th>
                                        <th className="p-2 border text-left">Bortelag</th>
                                        <th className="p-2 border text-center w-12">H</th>
                                        <th className="p-2 border text-center w-12">U</th>
                                        <th className="p-2 border text-center w-12">B</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {matches.map((match) => {
                                        const selection = selections[match.id] || {};
                                        return (
                                            <tr key={match.id} className="hover:bg-gray-50">
                                                <td className="p-2 border">{match.id}</td>
                                                <td className="p-2 border">{match.homeTeam}</td>
                                                <td className="p-2 border">{match.awayTeam}</td>
                                                <td className="p-2 border text-center">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selection.H || false}
                                                        onChange={() => handleSelection(match.id, 'H')}
                                                        className="h-4 w-4"
                                                    />
                                                </td>
                                                <td className="p-2 border text-center">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selection.U || false}
                                                        onChange={() => handleSelection(match.id, 'U')}
                                                        className="h-4 w-4"
                                                    />
                                                </td>
                                                <td className="p-2 border text-center">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selection.B || false}
                                                        onChange={() => handleSelection(match.id, 'B')}
                                                        className="h-4 w-4"
                                                    />
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TippingApp />, document.getElementById('root'));
    </script>
</body>
</html>
